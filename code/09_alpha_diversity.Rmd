---
title: "Alpha diversity"
author: "Yanxian Li<br><small>Department of Paraclinical Sciences<br>Faculty of Veterinary Medicine<br>Norwegian University of Life Sciences</small>"
date: "<small>`r Sys.Date()`</small>"
output:
  html_document:
    toc: yes
    toc_depth: 3
    number_sections: true
    toc_float: 
      collapsed: true
    code_folding: show
    theme: cerulean
    self_contained: true
  pdf_document: 
    latex_engine: xelatex
  word_document: default  
---

```{r style, echo = FALSE, message = FALSE, warning = FALSE}
require(knitr)
options(width = 120)
opts_chunk$set(message = FALSE, error = FALSE, warning = FALSE, cache = FALSE)
```

`r Hmisc::hidingTOC(buttonLabel = "Outline (hide)", tocSide = "left",  buttonSide = "left")`

# Getting ready

Load packages

```{r}
library(here) # A Simpler Way to Find Your Files, CRAN v1.0.1
library(tidyverse) # Easily Install and Load the 'Tidyverse', CRAN v1.3.0 
library(cowplot) # Streamlined Plot Theme and Plot Annotations for 'ggplot2', CRAN v1.1.1  
library(ggtext) # Improved Text Rendering Support for 'ggplot2', CRAN v0.1.1
library(ggsignif) # Significance Brackets for 'ggplot2', CRAN v0.6.0
library(RColorBrewer) # ColorBrewer Palettes, CRAN v1.1-2 
library(phyloseq) # Handling and analysis of high-throughput microbiome census data, Bioconductor v1.34.0 
library(microbiome) # Microbiome Analytics, Bioconductor v1.12.0
library(picante) # Integrating Phylogenies and Ecology, CRAN v1.8.2 
library(afex) # Analysis of Factorial Experiments, CRAN v0.28-1 
library(ggResidpanel) # Panels and Interactive Versions of Diagnostic Plots using 'ggplot2', CRAN v0.3.0 
library(emmeans) # Estimated Marginal Means, aka Least-Squares Means, CRAN v1.5.3 

# Set seed
set.seed(1910)
```

Load data

```{r}
# load phyloseq object
ps <- readRDS(here("data/intermediate/qiime2R/phyloseq.rds"))

# filter samples
ps <- ps %>%
  # remove control samples
  subset_samples(!SampleType %in% c("Extraction-blank", "PCR-blank", "Mock")) %>%
  # remove technical replicates
  subset_samples(!(IsTechnicalReplicate == "yes" & PCRBatch == 2))

# extract metadata
mtd <- data.frame(sample_data(ps), check.names = FALSE)
```

# Compute alpha diversity

Here, we compute the alpha diversity via the `alpha()` and `pd()` function from the *microbiome* and *picante* package, respectively.

```{r}
# compute Observed features, Peilou's Evenness and Shannon's index
alph_nphy <- alpha(ps, index = c("observed", "evenness_pielou", "diversity_shannon")) %>%
  rownames_to_column("SampleID")

# compute Faith's Phylogenetic Diversity
alph_phy <- pd(samp = t(otu_table(ps)), tree = phy_tree(ps), include.root = F) %>%
  select(PD) %>%
  rownames_to_column("SampleID")

# combine data
alph <- inner_join(alph_nphy, alph_phy, by = "SampleID") %>%
  inner_join(rownames_to_column(mtd, "SampleID"), by = "SampleID") %>%
  rename("Observed OTUs" = observed, "Pielou's evenness" = evenness_pielou, 
         "Shannon's index" = diversity_shannon, "Faith's PD" = PD) %>%
  pivot_longer("Observed OTUs":"Faith's PD", 
               names_to = "alph_indx", 
               values_to = "value") %>%
  mutate(
    FishID = factor(FishID, levels = unique(FishID)), 
    Tank = factor(Tank, levels = unique(Tank)), 
    SampleOrigin = factor(
      SampleOrigin, 
      levels = c("Digesta", "Mucosa", "Feed", "Water")),
    alph_indx = factor(
      alph_indx, 
      levels = c("Observed OTUs", "Pielou's evenness", "Shannon's index", "Faith's PD")))
```

# Plot alpha diversity

```{r, fig.width=6, fig.height=7}
ggplot(alph, aes(x = Diet, y = value)) +
  geom_point(
    aes(group = Compartment), 
    alpha = 0.3, 
    position = position_dodge(0.5)) +
  stat_summary(
    data = filter(alph, !SampleType %in% c("Feed", "Water")),
    aes(color = Compartment, group = Compartment), 
    fun.data = "mean_sdl", 
    fun.args = list(mult = 1), 
    geom = "pointrange",  
    size = 0.5,
    position = position_dodge(0.5)) +
  geom_line(
    data = filter(alph, !SampleType %in% c("Feed", "Water")) %>%
      group_by(alph_indx, Diet, SampleOrigin, Compartment) %>% 
      summarise(m = mean(value)),
    aes(y = m, color = Compartment, group = Compartment, linetype = Compartment), 
    size = 0.5, 
    position = position_dodge(0.5)) + 
  facet_grid(alph_indx ~ SampleOrigin, scales = "free_y") +
  scale_color_brewer(palette = "Dark2") +
  labs(color = "Compartment", linetype = "Compartment") +
  theme_bw(base_size = 12) +
  theme(legend.position = "top",
        strip.text.y = element_text(angle = 0))
```

# Compare alpha diversity

## Digesta

### Fit linear mixed effects models

Here we use the `mixed` function from the *afex* package to fit linear mixed effects models. Below we set up a maximal model based on the experimental design. The *p*-value of fixed effects is calculated using the Kenward-Roger approximation, which provides the best control against anti-conservative results.

```{r, message=TRUE}
# filter data
alph_dgs <- filter(alph,  SampleOrigin == "Digesta")

# split data
alph_dgs_spl <- split(alph_dgs, alph_dgs$alph_indx)

# fit model
lme_dgs <- lapply(alph_dgs_spl, function(x) {
  mixed(log1p(value) ~ Diet * Compartment + (1|FishID) + (1|Tank), 
        data = x, method = "KR")
  }
)
```

### Model outputs

```{r}
lme_dgs
```

### Model diagnostics

Here we use the *ggResidpanel* package to produce a panel of plots for residual diagnostics.

```{r, results='hide'}
lapply(
  seq_along(lme_dgs), 
  function(x) 
  {
    # extract titles 
    main <- ggdraw() + draw_label(names(lme_dgs)[x], fontface='bold')
    
    # make residual diagnostic plots
    resid_panel <- resid_panel(lme_dgs[[x]]$full_model, plots = "all", qqbands = TRUE)
    
    # assemble plots
    plot_grid(main, resid_panel, ncol = 1, rel_heights = c(1, 10))
  }
)
```

Everything looks fine. We proceed to post-hoc tests.

### Post-hoc tests

When interactions between main factors are significant, marginal means averaged over the levels of other covariates in the model can be misleading. A good practice is to do conditional contrasts.

```{r}
# filter alpha-diversity indices showing significant interactions between the main effects
intr_dgs <- lapply(lme_dgs, function(x) {
  ifelse(x$anova_table["Diet:Compartment", "Pr(>F)"] < 0.05, TRUE, FALSE)
  }
)

# conditional contrasts
cc_dgs <- mapply(function(x, y){
  # compute estimated marginal means 
  emm <- emmeans(x, ~ Diet * Compartment)

  # make conditional contrasts if the interaction is significant
  if (y == TRUE){
    contrast(emm, method = "consec", simple = "each", combine = TRUE, adjust = "mvt") %>%
    summary()
  }
},
  x = lme_dgs, 
  y = intr_dgs
)

cc_dgs
```

## Mucosa

### Fit linear mixed effects models

```{r, message=TRUE}
# filter data
alph_mcs <- filter(alph,  SampleOrigin == "Mucosa") %>%
  droplevels()

# split data
alph_mcs_spl <- split(alph_mcs, alph_mcs$alph_indx)

# fit model
lme_mcs <- lapply(alph_mcs_spl, function(x) {
  mixed(log1p(value) ~ Diet * Compartment + (1|FishID) + (1|Tank), 
        data = x, method = "KR")
  }
)
```

The fitted models are singular. Let's look at the estimated random effects.

```{r}
lapply(lme_mcs, function(x) summary(x)$varcor) 
```

The standard deviation of random effect `FishID` is zero for all the alpha indices. The standard deviation of random effect `Tank` is also zero for Faith's PD. We first update the models by removing the random effect `FishID`.

```{r, message=TRUE}
lme_mcs1 <- lapply(alph_mcs_spl, function(x) {
  mixed(log1p(value) ~ Diet * Compartment + (1|Tank), 
        data = x, method = "KR")
  }
)

lme_mcs1
```

Robust results should hold in both maximal and reduced model. Therefore, let us compare the pattern of significant and non-significant effects before and after removing the random effect `FishID`.

```{r}
map2_dfr(
  lme_mcs, 
  lme_mcs1, 
  ~left_join(nice(.x), nice(.y), by = "Effect", suffix = c("_full", "_reduced")),
  .id = "alpha_diversity")
```

The pattern of significant and non-significant effect is largely the same for both models. However, the reduced model for Faith's PD is still singular after removing the random effect `FishID`. To respect the experimental design, We just keep the random effect `Tank` in the model anyway. Now We proceed to model diagnostics.

### Model diagnostics

```{r, results='hide'}
lapply(
  seq_along(lme_mcs1), 
  function(x) 
  {
    # extract titles 
    main <- ggdraw() + draw_label(names(lme_mcs1)[x], fontface='bold')
    
    # make residual diagnostic plots
    resid_panel <- resid_panel(lme_mcs1[[x]]$full_model, plots = "all", qqbands = TRUE)
    
    # assemble plots
    plot_grid(main, resid_panel, ncol = 1, rel_heights = c(1, 10))
  }
)
```

The residual plot of Shannon's index doesn't look so good. Everything else looks fine. We proceed to post-hoc tests.

### Post-hoc tests

Conditional contrasts.

```{r}
# filter alpha-diversity indices showing significant interactions between the main effects
intr_mcs <- lapply(lme_mcs1, function(x) {
  ifelse(x$anova_table["Diet:Compartment", "Pr(>F)"] < 0.05, TRUE, FALSE)
  }
)

# Conditional contrasts
cc_mcs <- mapply(function(x, y){
  # Compute estimated marginal means 
  emm <- emmeans(x, ~ Diet * Compartment)

  # Make conditional contrasts if the interaction is significant
  if (y == TRUE){
    contrast(emm, method = "consec", simple = "each", combine = TRUE, adjust = "mvt") %>%
    summary()
  }
},
  x = lme_mcs1, 
  y = intr_mcs
)

cc_mcs
```

## Water vs mucosa

Aggregate alpha diversity of mucosa samples in each tank.

```{r}
alph_tm <- filter(alph, SampleOrigin %in% c("Water", "Mucosa")) %>%
  group_by(alph_indx, SampleOrigin, Compartment, Tank) %>%
  summarise(value = mean(value)) %>%
  mutate(
    SampleType = case_when(
      Compartment == "PI" ~ "PIM",
      Compartment == "DI" ~ "DIM",
      TRUE ~ "Water")) %>%
  ungroup() %>%
  select(-Compartment, -SampleOrigin)
```

Paired t-test.

```{r}
t_test <- pivot_wider(alph_tm, names_from = SampleType, values_from = value) %>%
  pivot_longer(PIM:DIM, names_to = "SampleType", values_to = "value") %>%
  group_by(alph_indx, SampleType) %>%
  nest() %>%
  mutate(t_test = map(data, ~t.test(.x$Water, .x$value, paired = TRUE, alternative = "two.sided")),
         p_raw = map_dbl(t_test, ~pluck(.x, "p.value"))) %>%
  group_by(alph_indx) %>%
  nest() %>%
  mutate(p_adj = map(data, ~p.adjust(.x$p_raw, method = "holm"))) %>%
  unnest(cols = c(data, p_adj)) %>%
  mutate(p_raw = formatC(p_raw, format = "f", digits = 3),
         p_adj = formatC(p_adj, format = "f", digits = 3),
         comparison = paste0("Water", "-", SampleType)) %>%
  select(alph_indx, comparison, p_raw, p_adj)

t_test
```

# Figures

## Figure 4

Gather *p*-values of main effects and their interaction.

```{r}
# digesta samples 
p_main_dgs <- lme_dgs %>% 
  map_dfr(~rownames_to_column(.x$anova_table, "term"), .id = "alph_indx") %>%
  mutate(SampleOrigin = "Digesta")

# mucosa samples 
p_main_mcs <- lme_mcs1 %>% 
  map_dfr(~rownames_to_column(.x$anova_table, "term"), .id = "alph_indx") %>%
  mutate(SampleOrigin = "Mucosa")

# merge and tidy data for main effect p value annotation
p_main <- bind_rows(p_main_dgs, p_main_mcs) %>%
  select(-c(`num Df`:F)) %>%
  pivot_wider(names_from = term, values_from = "Pr(>F)") %>%
  mutate_if(is.numeric, ~formatC(.x, format = "f", digits = 3)) %>% # format p value
  mutate(
    SampleOrigin =  factor(SampleOrigin, levels = c("Digesta", "Mucosa")),
    # format text using markdown (ggtext)
    lab_main = paste0(
      paste0("Diet: *p* = ", Diet), # *p*, italic
     "<br>", # new line
      paste0("Compartment: *p* = ", Compartment), 
      "<br>",
      paste0("Interaction: *p* = ", `Diet:Compartment`)),
    lab_main = gsub("= 0.000", "< 0.001", lab_main))
```

Gather *p*-values of post-hoc tests.

```{r}
# digesta samples 
p_cc_dgs <- bind_rows(cc_dgs, .id = "alph_indx") %>%
  mutate(SampleOrigin = "Digesta")

# mucosa samples 
p_cc_mcs <- bind_rows(cc_mcs, .id = "alph_indx") %>%
  mutate(SampleOrigin = "Mucosa")

# merge and tidy data for post-hoc test p value annotation
p_cc <- bind_rows(p_cc_dgs, p_cc_mcs) %>%
  mutate(SampleOrigin =  factor(SampleOrigin, levels = c("Digesta", "Mucosa"))) %>%
  # the "end" comes before "start" because we need to use REF/PI as the starting point
  separate(contrast, sep = " - ", c("end", "start")) %>%
  select(alph_indx, SampleOrigin, Diet, Compartment, start, end, p.value) %>%
  rename(p = p.value) %>%
  arrange(
    match(alph_indx, c("Observed OTUs", "Pielou's evenness", "Shannon's index", "Faith's PD")),
    match(start, c("PI", "DI", ".")),
    match(end, c("REF", "IM", "."))) %>%
  mutate(
    # convert p values to corresponding asterisks
    p = ifelse(p < 0.001, "***", p),
    p = ifelse(p >= 0.001 & p < 0.01, "**", p),
    p = ifelse(p >= 0.01 & p < 0.05, "*", p),
    p = ifelse(p >= 0.05, "NS", p),
    # start and end position of horizontal bar on the x axis 
    start = case_when(
      Diet == "REF" & Compartment == "." ~ 0.8,
      Diet == "IM" & Compartment == "." ~ 1.8,
      Diet == "." & Compartment == "PI" ~ 0.8,
      TRUE ~ 1.2),
    end = case_when(
      Diet == "REF" & Compartment == "." ~ 1.2,
      Diet == "IM" & Compartment == "." ~ 2.2,
      Diet == "." & Compartment == "PI" ~ 1.8,
      TRUE ~ 2.2),
    # position of p value on the x axis 
    p_xpos = (start + end) / 2,
    # position of horizontal bar and p value on the y axis 
    y = c(0.8, 0.85, 0.95, 1.0, 0.9, 0.95, 1.05, 1.1,
          4.2, 4.4, 3.75, 4.0, 4.6, 4.9, 4.25, 4.5)) 
```

Alpha diversity plots.

```{r}
plist <- lapply(levels(alph$alph_indx), function(x) {
  # filter data
  alph_sub <- filter(alph, alph_indx == x)
  
  alph_m <- filter(alph_sub, !SampleType %in% c("Feed", "Water")) %>%
    group_by(alph_indx, Diet, SampleOrigin, Compartment) %>% 
    summarise(m = mean(value))
  
  p_main_sub <- filter(p_main, alph_indx == x)
  
  p_cc_sub <- filter(p_cc, alph_indx == x)
  
  # make plots
  ggplot(alph_sub, aes(x = Diet, y = value)) +
    geom_point(
      aes(group = Compartment), 
      alpha = 0.3, 
      position = position_dodge(0.8)) +
    # add data summary: mean Â± sd
    stat_summary(
      data = filter(alph_sub, !SampleType %in% c("Feed", "Water")),
      aes(color = Compartment, group = Compartment), 
      fun.data = "mean_sdl", 
      fun.args = list(mult = 1), 
      geom = "pointrange",  
      size = 0.5,
      position = position_dodge(0.8)) +
    # use line to show changes in the group means
    geom_line(
      data = alph_m,
      aes(y = m, color = Compartment, group = Compartment, linetype = Compartment), 
      size = 0.5, 
      position = position_dodge(0.8)) + 
    # add p values of main effects
    geom_richtext(
      data = p_main_sub,
      aes(x = Inf, y = Inf, label = lab_main), 
      fill = NA, # remove background 
      label.color = NA, # remove outline
      size = 3, 
      hjust = 1, 
      vjust = 1.05) +
    # the following two geoms add p values of post-hoc tests
    geom_segment( # add bar
      data = p_cc_sub,
      aes(x = start, xend = end, y = y, yend = y)) +
    geom_text( # add p values
      data = p_cc_sub,
      aes(x = p_xpos, y = y, label = p), 
      size = 3, 
      vjust = -0.1) +
    facet_wrap(~SampleOrigin, nrow = 1) +
    scale_color_brewer(palette = "Dark2") +
    scale_y_continuous(expand = expansion(mult = c(0.03, 0.4))) +
    labs(x = "", y = x, color = "Compartment", linetype = "Compartment") +
    theme_bw(base_size = 12) +
    theme(legend.position = "top", strip.text.y = element_blank())
  }
)
```

Assemble plots.

```{r, fig.width=7, fig.height=11}
plot_grid(
  plist[[1]] + 
    theme(axis.text.x = element_blank(), 
          legend.margin = margin(0, 0, 0, 0),
          legend.box.margin = margin(0, 0, -8, 0)),
  plist[[2]] + 
    theme(axis.text.x = element_blank(), 
          legend.position = "none",
          plot.margin = margin(t = -0.7, unit = "cm")),
  plist[[3]] + 
    theme(axis.text.x = element_blank(), 
          legend.position = "none",
          plot.margin = margin(t = -0.5, unit = "cm")),
  plist[[4]] + 
    theme(legend.position = "none",
          plot.margin = margin(t = -0.5, unit = "cm")) + 
    labs(x = "Diet"),
  ncol = 1, align = "v", rel_heights = c(1.3, 1, 1, 1.1)) 

# export plot
ggsave(here("result/figure/Figure 4.tiff"), width = 7, height = 11,
       units = "in", dpi = 300, compression = "lzw")
```

## Figure S2

Initial box plot.

```{r}
bp_wt_mcs <- alph_tm %>%
  mutate(SampleType = factor(SampleType, levels = c("Water", "PIM", "DIM"))) %>%
  ggplot(aes(x = SampleType, y = value)) +
  geom_boxplot(aes(color = SampleType)) +
  geom_point(aes(color = SampleType)) +
  facet_wrap(~alph_indx, scales = "free_y", nrow = 1) +
  scale_y_continuous(expand = expansion(mult = c(0.05, 0.1))) +
  scale_color_manual(values = c("grey50", brewer.pal(4, "Paired"))) +
  labs(x = "Sample type", color = "Sample type") +
  theme_bw(base_size = 12) +
  theme(legend.position = "none")

bp_wt_mcs
```

Add *p* values.

```{r, fig.width=8, fig.height=4}
# make a dataframe for p value annotation
p_t.test <- ungroup(t_test) %>%
  separate(comparison, sep = "-", c("start", "end")) %>%
  mutate(p_adj = paste0("italic(p) == ", p_adj),
  y = c(150, 160, 0.91, 0.94, 3.8, 3.9, 47, 50))

# add p value annotation
bp_wt_mcs + geom_signif(
  data = p_t.test,
  aes(xmin = start, xmax = end, annotations = p_adj, y_position = y),
  tip_length = 0.01,
  textsize = 3,
  parse = TRUE,
  manual = T)

# export plot
ggsave(here("result/figure/Figure S2.tiff"), width = 8, height = 4,
       units = "in", dpi = 300, compression = "lzw")
```

# Session information

```{r session-info}
sessionInfo()
```
